pool:
  vmImage: ubuntu-latest

variables:
  VERSION_TAG: '0.12.0'
  containerRegistry: 'Container Registry - piosupportacr'
  containerRegistryFullName: 'piosupportacr.azurecr.io'
  repository: 't-rex'


steps:
  # Create Timestamp pipeline variable
  - script: |
      echo "##vso[task.setvariable variable=timeStamp]$(date +%y%m%d%H%M%S)"
    displayName: createTimestamp

  - task: Docker@2
    displayName: dockerBuild
    inputs:
      containerRegistry: $(containerRegistry)
      repository: 't-rex'
      command: 'build'
      arguments: --build-arg VERSION_TAG='$(VERSION_TAG)'
      Dockerfile: 't-rex/Dockerfile'
      tags: |
        $(VERSION_TAG)
        $(VERSION_TAG)-test
        $(Build.BuildId)-$(timeStamp)
        latest

  - task: Docker@2
    displayName: dockerPushTestImage

    inputs:
      containerRegistry: $(containerRegistry)
      repository: 't-rex'
      command: 'push'
      tags: |
        $(VERSION_TAG)-test

  - script: |
      docker run $(containerRegistryFullName)/$(repository):$(VERSION_TAG)-test --jimbo
      exit $?


    displayName: Test
    failOnStderr: false



  # - task: Docker@2
  #   inputs:
  #     containerRegistry: $(containerRegistry)
  #     repository: 't-rex'
  #     command: 'push'
  #     tags: |
  #       $(VERSION_TAG)
  #       $(Build.BuildId)-$(Release.Deployment.StartTime)
  #       latest


